{% extends 'base.html' %}
{% block title %}Admin Dashboard | StockMed{% endblock %}
{% block content %}
<div class="container-fluid px-3 px-md-4">

  <div class="d-flex align-items-center justify-content-between my-3">
    <h3 class="mb-0">Dashboard</h3>
    <div class="d-flex gap-2">
      <a href="{% url 'inventory:send_test_email' %}" class="btn btn-outline-dark">
        <i class="bi bi-envelope"></i> Send Alerts Email
      </a>        
      <a href="{% url 'inventory:product_create' %}" class="btn btn-success">+ Add Product</a>
      <a href="{% url 'inventory:product_import' %}" class="btn btn-outline-primary">Import Data</a>
    </div>
  </div>

  {% include 'inventory/_mini_cards.html' %}

  <div class="row g-3 mt-1">

    <div class="col-lg-8">
      <div class="card h-100 shadow-sm border-0">
        <div class="card-header bg-white">
          <strong>Product Analytics</strong>
        </div>
        <div class="card-body">
          <canvas id="categoryChart" height="120"></canvas>
        </div>
      </div>
    </div>

    <!-- Reminders  -->
    <div class="col-lg-4">
      <div class="card h-100 shadow-sm border-0">
        <div class="card-header bg-white">
          <strong>Status</strong>
        </div>
        <div class="card-body">
          <canvas id="stockChart" height="120"></canvas>
          <hr>
          <p class="mb-1"><strong>Suppliers:</strong> {{ metrics.total_suppliers }}</p>
          <p class="mb-0"><strong>Categories:</strong> {{ metrics.total_categories }}</p>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mt-1">
    <!-- Low stock list -->
    <div class="col-lg-6">
      <div class="card h-100 shadow-sm border-0">
        <div class="card-header bg-white"><strong>Low Stock</strong></div>
        <div class="card-body">
          <ul class="list-group list-group-flush">
            {% for p in low_list %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <a href="{% url 'inventory:product_detail' p.pk %}">{{ p.name }}</a>
                <span class="badge bg-danger">{{ p.quantity_in_stock }}</span>
              </li>
            {% empty %}
              <li class="list-group-item text-muted">No items.</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>

    <!-- Expiring soon -->
    <div class="col-lg-6">
      <div class="card h-100 shadow-sm border-0">
        <div class="card-header bg-white"><strong>Expiring Soon</strong></div>
        <div class="card-body">
          <ul class="list-group list-group-flush">
            {% for p in exp_list %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <a href="{% url 'inventory:product_detail' p.pk %}">{{ p.name }}</a>
                <span class="badge bg-warning text-dark">{{ p.expiry_date }}</span>
              </li>
            {% empty %}
              <li class="list-group-item text-muted">No items.</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Team / Users table -->
  <div class="row g-3 mt-1">
    <div class="col-12">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white d-flex justify-content-between">
          <strong>Team Collaboration</strong>
          <a href="{% url 'accounts:add_member' %}" class="btn btn-sm btn-outline-secondary">+ Add Member</a>
        </div>
        <div class="card-body">
          <div class="mb-3"><canvas id="usersChart" height="120"></canvas></div>
          <div class="table-responsive">
            <table class="table align-middle">
              <thead class="table-light">
                <tr>
                  <th>Profile</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Status</th>
                  <th>Categories</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for emp in employees %}
                  <tr>
                    <td>
                      {% if emp.profile_image %}
                        <img src="{{ emp.profile_image.url }}" class="rounded-circle" style="width:40px;height:40px;object-fit:cover;">
                      {% else %}
                        <div class="rounded-circle bg-light border d-flex align-items-center justify-content-center"
                             style="width:40px;height:40px;">â€”</div>
                      {% endif %}
                    </td>
                    <td>{{ emp.get_full_name|default:emp.username }}</td>
                    <td><a href="mailto:{{ emp.email }}">{{ emp.email }}</a></td>
                    <td><span class="badge bg-secondary">{{ emp.get_role_display }}</span></td>
                    <td>
                      {% if emp.is_active %}
                        <span class="badge bg-success">Active</span>
                      {% else %}
                        <span class="badge bg-secondary">Inactive</span>
                      {% endif %}
                    </td>
                    <td style="min-width:240px;">
                      {% if emp.categories_assigned.all %}
                        {% for cat in emp.categories_assigned.all %}
                          <span class="badge bg-info text-dark me-1 mb-1">{{ cat.name }}</span>
                        {% endfor %}
                      {% else %}
                        <span class="text-muted">No category assigned</span>
                      {% endif %}
                    </td>
                    <td class="text-nowrap">
                      <a href="{% url 'accounts:member_edit' emp.pk %}" class="btn btn-sm btn-outline-primary">Edit</a>
                      <form method="post" action="{% url 'accounts:member_delete' emp.pk %}" style="display:inline;"
                            onsubmit="return confirm('Delete this member?');">
                        {% csrf_token %}
                        <button class="btn btn-sm btn-outline-danger">Delete</button>
                      </form>
                    </td>
                  </tr>
                {% empty %}
                  <tr><td colspan="7" class="text-muted">No employees found.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block extra_js %}
<script type="application/javascript">
  const catLabels = {{ cat_labels|safe }};
  const catQty = {{ cat_qty|safe }};
  const lowCount = {{ low_vs_ok.low|default:0 }};
  const okCount = {{ low_vs_ok.ok|default:0 }};
  const usersLabels = {{ user_labels|safe }};
  const usersCounts = {{ user_counts|safe }};


new Chart(document.getElementById('categoryChart'), {
    type: 'bar',
    data: {
        labels: JSON.parse('{{ cat_labels|escapejs }}'),
        datasets: [{
            label: 'Quantity',
            data: JSON.parse('{{ cat_qty|escapejs }}'),
            backgroundColor: '#4e73df',
            borderRadius: 6,
            barThickness: 40
        }]
    },
    options: {
        indexAxis: 'y',
        responsive: true,
        plugins: {
            legend: { display: false },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return 'Qty: ' + context.formattedValue;
                    }
                }
            }
        },
        scales: {
            x: { beginAtZero: true }
        }
    }
});



new Chart(document.getElementById('stockChart'), {
      type: 'doughnut',
      data: {
          labels: ['Low Stock', 'OK'],
          datasets: [{ data: [{{ low_count }}, {{ ok_count }}], backgroundColor: ['#e74a3b', '#1cc88a'] }]
      }
  });

new Chart(document.getElementById('usersChart'), {
      type: 'bar',
      data: {
          labels: {{ user_labels|safe }},
          datasets: [{ label: 'Assigned Categories', data: {{ user_counts|safe }}, backgroundColor: '#36b9cc', borderRadius: 6, barThickness: 50, }]
      }
  });
</script>
{% endblock %}
